<body>
    <div class="header">ğŸ´ AVCÄ° 101 OKEY PLUS</div>
    <div class="istaka-container">
        <div class="istaka" id="istaka"></div>
    </div>
    
    <div id="puanBox" style="position: fixed; bottom: 85px; left: 15px; background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 15px; border: 1px solid gold; color: gold; font-weight: bold; font-size: 14px;">
        Per ToplamÄ±: <span id="perPuani">0</span>
    </div>

    <div class="controls">
        <button onclick="otomatikDiz()" style="background: #f39c12;">ğŸª„ DÄ°Z</button>
        <button onclick="taslariYukle()">ğŸ”„ Yenile</button>
        <button onclick="window.Telegram.WebApp.close()" style="background:#c0392b">âŒ Kapat</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let mevcutEl = [];
        let seciliIdx = null;

        async function taslariYukle() {
            const user = tg.initDataUnsafe.user;
            const chat_id = tg.initDataUnsafe.chat_instance || user.id.toString();
            const response = await fetch(`/get_hand?user_id=${user.id}&chat_id=${chat_id}`);
            const el = await response.json();
            mevcutEl = new Array(30).fill(null);
            el.forEach((t, i) => { if(i<30) mevcutEl[i] = t; });
            arayuzuGuncelle();
        }

        async function otomatikDiz() {
            const user = tg.initDataUnsafe.user;
            const chat_id = tg.initDataUnsafe.chat_instance || user.id.toString();
            const response = await fetch('/auto_sort', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: user.id, chat_id: chat_id})
            });
            const data = await response.json();
            if(data.success) {
                mevcutEl = data.yeni_el;
                document.getElementById('perPuani').innerText = data.puan;
                arayuzuGuncelle();
            }
        }

        function arayuzuGuncelle() {
            const istakaDiv = document.getElementById('istaka');
            istakaDiv.innerHTML = '';
            mevcutEl.forEach((tas, idx) => {
                const div = document.createElement('div');
                div.className = `tas ${tas ? tas.renk : 'bos'} ${seciliIdx === idx ? 'secili' : ''}`;
                div.innerText = tas ? tas.sayi : '';
                div.onclick = async () => {
                    if(seciliIdx === null) {
                        if(mevcutEl[idx]) { seciliIdx = idx; arayuzuGuncelle(); }
                    } else {
                        const temp = mevcutEl[idx];
                        mevcutEl[idx] = mevcutEl[seciliIdx];
                        mevcutEl[seciliIdx] = temp;
                        seciliIdx = null;
                        arayuzuGuncelle();
                        await eliKaydet();
                    }
                };
                istakaDiv.appendChild(div);
            });
        }

        async function eliKaydet() {
            const user = tg.initDataUnsafe.user;
            const chat_id = tg.initDataUnsafe.chat_instance || user.id.toString();
            await fetch('/save_hand', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: user.id, chat_id: chat_id, el: mevcutEl})
            });
        }
        window.onload = taslariYukle;
    </script>
</body>