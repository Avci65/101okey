<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            background: radial-gradient(circle, #1a4a5e 0%, #0d2027 100%); 
            color: white; font-family: 'Arial', sans-serif; margin: 0; 
            display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; 
        }
        .header { width: 100%; padding: 8px; text-align: center; font-weight: bold; background: rgba(0,0,0,0.3); color: #00d2ff; font-size: 14px; }
        
        /* Istaka AlanÄ± */
        .istaka-container { flex-grow: 1; display: flex; align-items: center; width: 100%; justify-content: center; padding: 10px; }
        .istaka { 
            background: linear-gradient(to bottom, #d4a017 0%, #8b4513 100%); 
            width: 98%; max-width: 600px; 
            display: grid; 
            grid-template-columns: repeat(15, 1fr); 
            grid-template-rows: repeat(2, 1fr); 
            gap: 3px; padding: 6px; 
            border: 3px solid #5d2e0a; border-radius: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        /* TaÅŸ TasarÄ±mÄ± */
        .tas { 
            background: #fefefe; border-radius: 3px; display: flex; align-items: center; 
            justify-content: center; font-weight: 900; font-size: 1.1rem; height: 45px; 
            box-shadow: inset 0 -3px 0 #d1d1d1, 0 2px 4px rgba(0,0,0,0.4); 
            position: relative; transition: transform 0.1s; cursor: pointer;
        }

        /* Renkler */
        .kirmizi { color: #e74c3c !important; } 
        .mavi { color: #3498db !important; } 
        .siyah { color: #2c3e50 !important; } 
        .sari { color: #f39c12 !important; }
        
        .secili { outline: 3px solid gold; z-index: 10; transform: scale(1.1); box-shadow: 0 0 15px gold; }
        .bos { background: rgba(0,0,0,0.15); box-shadow: none; border: 1px solid rgba(255,255,255,0.05); }

        /* Puan Kutusu */
        #puanBox {
            position: fixed; bottom: 85px; left: 15px; 
            background: rgba(0,0,0,0.8); padding: 8px 15px; 
            border-radius: 15px; border: 1px solid gold; 
            color: gold; font-weight: bold; font-size: 14px;
            display: none; /* Ä°lk baÅŸta gizli, dizilince aÃ§Ä±lÄ±r */
        }

        .controls { width: 100%; display: flex; justify-content: center; gap: 10px; padding: 15px; background: rgba(0,0,0,0.5); }
        button { border: none; color: white; padding: 10px 18px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">ğŸ´ AVCÄ° 101 OKEY PLUS</div>
    
    <div class="istaka-container">
        <div class="istaka" id="istaka"></div>
    </div>

    <div id="puanBox">Per ToplamÄ±: <span id="perPuani">0</span></div>

    <div class="controls">
        <button onclick="otomatikDiz()" style="background: #f39c12;">ğŸª„ DÄ°Z</button>
        <button onclick="taslariYukle()" style="background: #4ca1af;">ğŸ”„ Yenile</button>
        <button onclick="window.Telegram.WebApp.close()" style="background:#c0392b">âŒ Kapat</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let mevcutEl = [];
        let seciliIdx = null;

        function renkFormatla(renk) {
            if (!renk) return 'bos';
            const r = renk.toLowerCase().trim();
            if (r.includes('kirmizi') || r.includes('kÄ±rmÄ±zÄ±') || r.includes('red')) return 'kirmizi';
            if (r.includes('mavi') || r.includes('blue')) return 'mavi';
            if (r.includes('sari') || r.includes('sarÄ±') || r.includes('yellow')) return 'sari';
            if (r.includes('siyah') || r.includes('black')) return 'siyah';
            return 'siyah';
        }
        function manuelPuanHesapla() {
    let toplam = 0;
    let geciciPer = [];

    for (let i = 0; i < mevcutEl.length; i++) {
        const tas = mevcutEl[i];

        if (tas !== null) {
            geciciPer.push(tas);
        } else {
            // BoÅŸluÄŸa denk gelindiÄŸinde mevcut per grubunu kontrol et
            if (geciciPer.length >= 3) {
                // BasitÃ§e per iÃ§indeki sayÄ±larÄ± topla
                toplam += geciciPer.reduce((sum, t) => sum + t.sayi, 0);
            }
            geciciPer = []; // Grubu sÄ±fÄ±rla
        }
    }
    // Listenin sonundaki grubu kontrol et
    if (geciciPer.length >= 3) {
        toplam += geciciPer.reduce((sum, t) => sum + t.sayi, 0);
    }

    document.getElementById('perPuani').innerText = toplam;

}

        async function taslariYukle() {
            const user = tg.initDataUnsafe.user;
            const chat_id = tg.initDataUnsafe.chat_instance || user.id.toString();
            try {
                const response = await fetch(`/get_hand?user_id=${user.id}&chat_id=${chat_id}`);
                const el = await response.json();
                mevcutEl = new Array(30).fill(null);
                if (Array.isArray(el)) {
                    el.forEach((t, i) => { if(i < 30) mevcutEl[i] = t; });
                }
                seciliIdx = null;
                arayuzuGuncelle();
            } catch (e) { console.error("Hata:", e); }
        }
        function perGecerliMi(grup) {
    if (grup.length < 3) return false;

    // Seri KontrolÃ¼ (AynÄ± renk, ardÄ±ÅŸÄ±k sayÄ±)
    const ayniRenk = grup.every(t => t.renk === grup[0].renk);
    const ardisik = grup.every((t, i) => i === 0 || t.sayi === grup[i-1].sayi + 1);
    if (ayniRenk && ardisik) return true;

    // Grup KontrolÃ¼ (AynÄ± sayÄ±, farklÄ± renk)
    const ayniSayi = grup.every(t => t.sayi === grup[0].sayi);
    const farkliRenk = new Set(grup.map(t => t.renk)).size === grup.length;
    if (ayniSayi && farkliRenk) return true;

    return false;
}

function manuelPuanHesapla() {
    let toplam = 0;
    let geciciPer = [];

    for (let i = 0; i < mevcutEl.length; i++) {
        const tas = mevcutEl[i];
        if (tas !== null) {
            geciciPer.push(tas);
        } else {
            if (perGecerliMi(geciciPer)) { // Sadece kurala uyuyorsa topla
                toplam += geciciPer.reduce((sum, t) => sum + t.sayi, 0);
            }
            geciciPer = [];
        }
    }
    if (perGecerliMi(geciciPer)) {
        toplam += geciciPer.reduce((sum, t) => sum + t.sayi, 0);
    }
    document.getElementById('perPuani').innerText = toplam;
}

        async function otomatikDiz() {
            const user = tg.initDataUnsafe.user;
            const chat_id = tg.initDataUnsafe.chat_instance || user.id.toString();
            try {
                const response = await fetch('/auto_sort', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: user.id, chat_id: chat_id})
                });
                const data = await response.json();
                if (data.success) {
                    mevcutEl = data.yeni_el;
                    document.getElementById('perPuani').innerText = data.puan;
                    document.getElementById('puanBox').style.display = 'block';
                    arayuzuGuncelle();
                }
            } catch (e) { console.error("Dizme hatasÄ±:", e); }
        }

        function arayuzuGuncelle() {
            const istakaDiv = document.getElementById('istaka');
            istakaDiv.innerHTML = '';
            mevcutEl.forEach((tas, idx) => {
                const div = document.createElement('div');
                div.className = `tas ${tas ? renkFormatla(tas.renk) : 'bos'} ${seciliIdx === idx ? 'secili' : ''}`;
                div.innerText = tas ? tas.sayi : '';
                div.onclick = async () => {
    if (seciliIdx === null) {
        if (mevcutEl[idx]) { seciliIdx = idx; arayuzuGuncelle(); }
    } else {
        const temp = mevcutEl[idx];
        mevcutEl[idx] = mevcutEl[seciliIdx];
        mevcutEl[seciliIdx] = temp;
        seciliIdx = null;
        
        // Yer deÄŸiÅŸtirme sonrasÄ± hem arayÃ¼zÃ¼ hem de puanÄ± gÃ¼ncelle
        arayuzuGuncelle();
        manuelPuanHesapla(); 
        await eliKaydet();
    }
};
                istakaDiv.appendChild(div);
            });
        }

        async function eliKaydet() {
            const user = tg.initDataUnsafe.user;
            const chat_id = tg.initDataUnsafe.chat_instance || user.id.toString();
            await fetch('/save_hand', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: user.id, chat_id: chat_id, el: mevcutEl})
            });
        }

        window.onload = taslariYukle;
    </script>
</body>
</html>