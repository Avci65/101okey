<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            background: radial-gradient(circle, #1a4a5e 0%, #0d2027 100%); 
            color: white; font-family: 'Arial', sans-serif; margin: 0; 
            display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; 
        }
        .header { width: 100%; padding: 8px; text-align: center; font-weight: bold; background: rgba(0,0,0,0.3); color: #00d2ff; font-size: 14px; }
        
        /* Istaka KonteynÄ±rÄ± - TaÅŸ boyutlarÄ±nÄ± dengelemek iÃ§in kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */
        .istaka-container { flex-grow: 1; display: flex; align-items: center; width: 100%; justify-content: center; padding: 10px; }
        .istaka { 
            background: linear-gradient(to bottom, #d4a017 0%, #8b4513 100%); 
            width: 98%; max-width: 600px; 
            display: grid; 
            /* 15 SÃ¼tun yaparak boÅŸluk alanÄ± aÃ§Ä±yoruz */
            grid-template-columns: repeat(15, 1fr); 
            grid-template-rows: repeat(2, 1fr); 
            gap: 3px; padding: 6px; 
            border: 3px solid #5d2e0a; border-radius: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        /* TaÅŸ BoyutlarÄ± KÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */
        .tas { 
            background: #fefefe; border-radius: 3px; display: flex; align-items: center; 
            justify-content: center; font-weight: 900; font-size: 1.1rem; height: 45px; 
            box-shadow: inset 0 -3px 0 #d1d1d1, 0 2px 4px rgba(0,0,0,0.4); 
            position: relative; cursor: grab; transition: transform 0.1s;
        }
        .tas:active { transform: scale(0.95); cursor: grabbing; }
        
        /* Renk KodlarÄ± */
        .kirmizi { color: #e74c3c; } .mavi { color: #3498db; } .siyah { color: #2c3e50; } .sari { color: #f1c40f; }
        
        /* BoÅŸ Slot GÃ¶rÃ¼nÃ¼mÃ¼ */
        .bos { background: rgba(0,0,0,0.15); box-shadow: none; border: 1px solid rgba(255,255,255,0.05); }

        .controls { width: 100%; display: flex; justify-content: center; gap: 10px; padding: 15px; background: rgba(0,0,0,0.5); }
        button { background: #4ca1af; border: none; color: white; padding: 8px 16px; border-radius: 5px; font-weight: bold; font-size: 13px; }
    </style>
</head>
<body>
    <div class="header">ğŸ´ AVCÄ° 101 OKEY PLUS</div>
    <div class="istaka-container">
        <div class="istaka" id="istaka">
            </div>
    </div>
    <div class="controls">
        <button onclick="taslariYukle()">ğŸ”„ Yenile</button>
        <button onclick="window.Telegram.WebApp.close()" style="background:#c0392b">âŒ Kapat</button>
    </div>

   <script>
    // Telegram WebApp nesnesini baÅŸlatÄ±yoruz
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand(); // UygulamayÄ± tam ekran yapÄ±yoruz

    let mevcutEl = [];
    let suruklenenIdx = null;

    // 1. VeritabanÄ±ndan Eli Ã‡eken Ana Fonksiyon
    async function taslariYukle() {
        const user = tg.initDataUnsafe.user;
        // chat_instance undefined gelirse yedek olarak user.id kullanÄ±yoruz
        const chat_id = tg.initDataUnsafe.chat_instance || (user ? user.id.toString() : '0');
        const istakaDiv = document.getElementById('istaka');

        if (!user) {
            istakaDiv.innerHTML = '<p style="grid-column: span 15; text-align: center;">KullanÄ±cÄ± verisi yok!</p>';
            return;
        }

        try {
            // Sunucudaki /get_hand rotasÄ±ndan veriyi Ã§ekiyoruz
            const response = await fetch(`/get_hand?user_id=${user.id}&chat_id=${chat_id}`);
            const el = await response.json();
            
            // Gelen listeyi 30 slotluk (15x2) Ä±staka yapÄ±sÄ±na yerleÅŸtiriyoruz
            mevcutEl = new Array(30).fill(null);
            if (Array.isArray(el)) {
                el.forEach((tas, i) => { if(i < 30) mevcutEl[i] = tas; });
            }
            
            arayuzuGuncelle();
        } catch (e) {
            console.error("Veri Ã§ekme hatasÄ±:", e);
            istakaDiv.innerHTML = '<p style="grid-column: span 15; text-align: center;">Veri yÃ¼klenemedi!</p>';
        }
    }

    // 2. TaÅŸ Hareketlerini VeritabanÄ±na Kaydeden Fonksiyon
    async function eliSunucuyaKaydet() {
        const user = tg.initDataUnsafe.user;
        const chat_id = tg.initDataUnsafe.chat_instance || (user ? user.id.toString() : '0');

        try {
            // bot.py'deki /save_hand POST rotasÄ±na gÃ¼ncel diziliÅŸi gÃ¶nderiyoruz
            const response = await fetch('/save_hand', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: user.id,
                    chat_id: chat_id,
                    el: mevcutEl // 30 slotluk gÃ¼ncel dizilim
                })
            });
            const result = await response.json();
            console.log("Sunucu yanÄ±tÄ±:", result);
        } catch (e) {
            console.error("Kaydetme hatasÄ±:", e);
        }
    }

    // 3. Istaka ArayÃ¼zÃ¼nÃ¼ Ã‡izen Fonksiyon
    function arayuzuGuncelle() {
        const istakaDiv = document.getElementById('istaka');
        istakaDiv.innerHTML = '';

        mevcutEl.forEach((tas, idx) => {
            const div = document.createElement('div');
            // TaÅŸ varsa rengine gÃ¶re sÄ±nÄ±f ver, yoksa 'bos' sÄ±nÄ±fÄ± ver
            div.className = `tas ${tas ? tas.renk.toLowerCase() : 'bos'}`;
            div.innerText = tas ? tas.sayi : '';
            div.draggable = true; // TÃ¼m slotlar sÃ¼rÃ¼klenebilir/bÄ±rakÄ±labilir

            // SÃ¼rÃ¼kle-BÄ±rak OlaylarÄ±
            div.ondragstart = () => { suruklenenIdx = idx; };
            div.ondragover = (e) => e.preventDefault();
            div.ondrop = async () => {
                // Yer deÄŸiÅŸtirme iÅŸlemi
                const temp = mevcutEl[idx];
                mevcutEl[idx] = mevcutEl[suruklenenIdx];
                mevcutEl[suruklenenIdx] = temp;
                
                // Ã–nce gÃ¶rseli gÃ¼ncelle, sonra sunucuya kaydet
                arayuzuGuncelle();
                await eliSunucuyaKaydet(); 
            };

            istakaDiv.appendChild(div);
        });
    }

    // Sayfa ilk yÃ¼klendiÄŸinde taÅŸlarÄ± getir
    window.onload = taslariYukle;
</script>
</body>
</html>