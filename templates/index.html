<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            background: radial-gradient(circle, #1a4a5e 0%, #0d2027 100%); 
            color: white; font-family: 'Arial', sans-serif; margin: 0; 
            display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; 
        }
        .header { width: 100%; padding: 8px; text-align: center; font-weight: bold; background: rgba(0,0,0,0.3); color: #00d2ff; font-size: 14px; }
        
        /* Istaka Alanƒ± */
        .istaka-container { flex-grow: 1; display: flex; align-items: center; width: 100%; justify-content: center; padding: 10px; }
        .istaka { 
            background: linear-gradient(to bottom, #d4a017 0%, #8b4513 100%); 
            width: 98%; max-width: 600px; 
            display: grid; 
            grid-template-columns: repeat(15, 1fr); /* 15 s√ºtunlu profesyonel dizilim */
            grid-template-rows: repeat(2, 1fr); 
            gap: 3px; padding: 6px; 
            border: 3px solid #5d2e0a; border-radius: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        /* Ta≈ü Tasarƒ±mƒ± */
        .tas { 
            background: #fefefe; border-radius: 3px; display: flex; align-items: center; 
            justify-content: center; font-weight: 900; font-size: 1.1rem; height: 45px; 
            box-shadow: inset 0 -3px 0 #d1d1d1, 0 2px 4px rgba(0,0,0,0.4); 
            position: relative; transition: transform 0.1s; cursor: pointer;
        }

        /* Renk Sabitleme (Kritik B√∂l√ºm) */
        .kirmizi { color: #e74c3c !important; } 
        .mavi { color: #3498db !important; } 
        .siyah { color: #2c3e50 !important; } 
        .sari { color: #f39c12 !important; }
        
        /* Se√ßili Ta≈ü Efekti */
        .secili { outline: 3px solid gold; z-index: 10; transform: scale(1.1); box-shadow: 0 0 15px gold; }
        .bos { background: rgba(0,0,0,0.15); box-shadow: none; border: 1px solid rgba(255,255,255,0.05); }

        .controls { width: 100%; display: flex; justify-content: center; gap: 10px; padding: 15px; background: rgba(0,0,0,0.5); }
        button { background: #4ca1af; border: none; color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">üé¥ AVCƒ∞ 101 OKEY PLUS</div>
    <div class="istaka-container">
        <div class="istaka" id="istaka"></div>
    </div>
    <div class="controls">
        <button onclick="taslariYukle()">üîÑ Yenile</button>
        <button onclick="window.Telegram.WebApp.close()" style="background:#c0392b">‚ùå Kapat</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let mevcutEl = [];
        let seciliIdx = null;

        // Renk ismini temizleyen ve e≈üle≈ütiren fonksiyon
        function renkFormatla(renk) {
            if (!renk) return 'bos';
            const r = renk.toLowerCase().trim();
            // T√ºrk√ße karakter ve farklƒ± yazƒ±m toleransƒ±
            if (r.includes('kirmizi') || r.includes('kƒ±rmƒ±zƒ±') || r.includes('red')) return 'kirmizi';
            if (r.includes('mavi') || r.includes('blue')) return 'mavi';
            if (r.includes('sari') || r.includes('sarƒ±') || r.includes('yellow')) return 'sari';
            if (r.includes('siyah') || r.includes('black')) return 'siyah';
            return 'siyah'; // Varsayƒ±lan
        }

        async function taslariYukle() {
            const user = tg.initDataUnsafe.user;
            const chat_id = tg.initDataUnsafe.chat_instance || (user ? user.id.toString() : '0');
            
            try {
                const response = await fetch(`/get_hand?user_id=${user.id}&chat_id=${chat_id}`);
                const el = await response.json();
                
                // 30 slotluk ƒ±staka yapƒ±sƒ±nƒ± olu≈ütur
                mevcutEl = new Array(30).fill(null);
                if (Array.isArray(el)) {
                    el.forEach((tas, i) => { if(i < 30) mevcutEl[i] = tas; });
                }
                seciliIdx = null; // Se√ßimi sƒ±fƒ±rla
                arayuzuGuncelle();
            } catch (e) {
                console.error("Y√ºkleme hatasƒ±:", e);
            }
        }

        function arayuzuGuncelle() {
            const istakaDiv = document.getElementById('istaka');
            istakaDiv.innerHTML = '';

            mevcutEl.forEach((tas, idx) => {
                const div = document.createElement('div');
                const renkSinifi = tas ? renkFormatla(tas.renk) : 'bos';
                div.className = `tas ${renkSinifi}`;
                
                // Eƒüer bu ta≈ü se√ßiliyse efekti uygula
                if (seciliIdx === idx) div.classList.add('secili');
                
                div.innerText = tas ? tas.sayi : '';

                // Mobil Uyumlu Tƒ±kla-Ta≈üƒ± Sistemi
                div.onclick = async () => {
                    if (seciliIdx === null) {
                        // ƒ∞lk tƒ±klama: Ta≈üƒ± se√ß
                        if (mevcutEl[idx] !== null) {
                            seciliIdx = idx;
                            arayuzuGuncelle();
                        }
                    } else {
                        // ƒ∞kinci tƒ±klama: Yer deƒüi≈ütir
                        const temp = mevcutEl[idx];
                        mevcutEl[idx] = mevcutEl[seciliIdx];
                        mevcutEl[seciliIdx] = temp;
                        
                        const eskiSecili = seciliIdx;
                        seciliIdx = null;
                        arayuzuGuncelle();
                        
                        // Sadece yer deƒüi≈üikliƒüi olduysa kaydet
                        if (eskiSecili !== idx) {
                            await eliKaydet();
                        }
                    }
                };

                istakaDiv.appendChild(div);
            });
        }

        async function eliKaydet() {
            const user = tg.initDataUnsafe.user;
            const chat_id = tg.initDataUnsafe.chat_instance || (user ? user.id.toString() : '0');
            
            try {
                await fetch('/save_hand', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: user.id,
                        chat_id: chat_id,
                        el: mevcutEl
                    })
                });
            } catch (e) {
                console.error("Kaydetme hatasƒ±:", e);
            }
        }

        window.onload = taslariYukle;
    </script>
</body>
</html>